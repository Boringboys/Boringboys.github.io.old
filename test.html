<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<meta charset="utf-8">
	<style type="text/css">
		# get_btn{height: 100,width:500;}
	</style>

</head>
<body>
	<div>
		<textarea id="prikey" rows="5" cols="80" placeholder="私钥"></textarea><br/>
		<button id="sign_btn">签名</button><br/><br/>

		<textarea id="pubkey" rows="5" cols="80" placeholder="公钥"></textarea><br/>
		<button id="verify_btn">验证</button><br/><br/>
		<button id="import_btn">我没有密钥，帮我导入默认的公私钥>_<</button><br/><br/>

		
		<textarea id="aeskey" rows="3" cols="80" placeholder="十六位的16进制对称密钥"></textarea><br/>
		<button id="encrypt_btn">加密</button><button id="decrypt_btn">解密</button><br/><br/>

		<textarea id="get" rows="5" cols="80" placeholder="显示读取到的内容"></textarea><br/>
		<textarea id="get_info" rows="2" cols="80" placeholder="显示验证正确后的内容"></textarea><br/>
		<button id="get_btn">get</button><br/><br/>
		<textarea id="set" rows="5" cols="80" placeholder="在这里输入要写入的内容"></textarea><br/>
		<button id="set_btn">set</button>
	</div>
	<!--script-->
	<script src="assets/js/jquery.min.js"></script>
	<script src="web3.js-0.20.6/dist/web3.min.js"></script>
	<script src="crypto-js-3.1.9-1/crypto-js.js"></script>
	<script src="kjur-jsrsasign-d282c71/jsrsasign-all-min.js"></script>

	<script>
		$(document).ready(function(){

			//aes密钥偏移量
			const iv = CryptoJS.enc.Utf8.parse('ABCDEF1234123412'); 			
			//默认的公私钥
			var prikey = "-----BEGIN RSA PRIVATE KEY-----\
MIICXAIBAAKBgQDL/TPQzVzzEzMXQKwX/6O7h188ntigmTsUOE3UXGt4ShHUshw6\
oQ6DzSxJTpJjYvbCVrbx2WeMX5J5+BmP43TeYd1Bt2sfZAfmAZJONqMDtRBG+R5k\
5HmGpzxqAo0lnI67yVpMCQMe6uunqWbrRQZNobwNqDnykJBOndZcVrdtzwIDAQAB\
AoGAOb3PiABJmkjKAn/89sIXH8Me8zLnkPYu4fdaGI2coi0dRP6xvOrQCADw00NZ\
bqaZwML5ABaRGAwJk1rmKXOyJatbtkDYYI7AHOENt0UWpI5RLoJhf5uyFDZdTaBW\
OO647wMlhWx2kjCuoKa0ox4wuTQMTY1Zw+NXMUUBvIkiKWkCQQDojT6bMd2yxFgN\
6hBlfBo43J8ZTfkG/xHwYDVvhf3Dnq7AnCMFvkDJhOoPBrlokx+7/ca6aIsRiAH9\
cgfoo1gdAkEA4I6usHBFVXVZaeZA14PRMrUrUse2vXsenHtNp01L2hI1hYpxywjw\
oevc11ba0HzY9n0+gIh0jKNN0wl9+Bux2wJAJTHCG6xkGx2QP9l5+eFZiFKxF6kC\
9X2CbwHUShwSNGGC7ceLSnXdgt3BWdnnebReVQEH8fSamZk5SEIexbSqeQJAUqp0\
CKPsAj/HAMMwz6XJF3+2SS0YSrzOUhDaT2KXL9pQNa73oSTTYOhxThy9RM8RF/yX\
S73wGe3sMmpmIzYezQJBAK4bFUErRbT0Vjy2oCxZF0Ocl/t7e/vQWZxX1mrPy2/3\
hPGx5BKDtFuzluSCJfG2tL+2zZFr63Lvbl9sxmoIp0c=\
-----END RSA PRIVATE KEY-----";

			var pubkey = "-----BEGIN PUBLIC KEY-----\
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDL/TPQzVzzEzMXQKwX/6O7h188\
ntigmTsUOE3UXGt4ShHUshw6oQ6DzSxJTpJjYvbCVrbx2WeMX5J5+BmP43TeYd1B\
t2sfZAfmAZJONqMDtRBG+R5k5HmGpzxqAo0lnI67yVpMCQMe6uunqWbrRQZNobwN\
qDnykJBOndZcVrdtzwIDAQAB\
-----END PUBLIC KEY-----";
			

			//导入默认公私钥
			$("#import_btn").click(function(){
				$("#prikey").val(prikey);
				$("#pubkey").val(pubkey);
			});

			//签名
			$("#sign_btn").click(function(){
				var key = $("#prikey").val();
				var info = $("#set").val();
				if(typeof key == "undefined" || key == null || key == ""){
        			alert("没有私钥啊！");
    			}
    			else if(typeof info == "undefined" || info == null || info == ""){
    				alert("没有要签名的内容！");
    			}
    			else{
    				var sig = new KJUR.crypto.Signature({"alg": "SHA1withRSA"});
					// initialize for signature generation
					sig.init(key);   // rsaPrivateKey of RSAKey object
					// update data
					sig.updateString(info);
					// calculate signature
					var sigValueHex = sig.sign();
					$("#set").val('["'+info+'","'+sigValueHex+'"]');
					console.log(sigValueHex);
    			}
			});


			//验证
			$("#verify_btn").click(function(){
				var key2 = $("#pubkey").val();
				var info2 = $("#get").val();
				if(typeof key2 == "undefined" || key2 == null || key2 == ""){
        			alert("没有公钥啊！");
    			}
    			else if(typeof info2 == "undefined" || info2 == null || info2 == ""){
    				alert("没有要验证的内容！");
    			}
    			else{
    				var obj = eval("(" + info2 + ")");

    				console.log(obj[0],obj[1]);
    				var sig1 = new KJUR.crypto.Signature({"alg": "SHA1withRSA"});
					// initialize for signature validation
					sig1.init(key2); // signer's certificate
					// update data
					sig1.updateString(obj[0]);
					// verify signature
					var isValid = sig1.verify(obj[1]);
					if(isValid){
						alert("验证正确");
						$("#get_info").val(obj[0]);
					}else{
						alert("验证错误");
					}
					console.log(isValid);
    			}
			});

			//加密
			$("#encrypt_btn").click(function(){
				var word1 = $("#set").val();
				var key3 = $("#aeskey").val();
				if(typeof key3 == "undefined" || key3 == null || key3 == ""){
        			alert("没有密钥啊！");
    			}
    			else if(typeof word1 == "undefined" || word1 == null || word1 == ""){
    				alert("没有要加密的内容！");
    			}
    			else{
    				if(key3.length != 16){
    					alert("密钥位数不对吧");
    				}else{
    					var key = CryptoJS.enc.Utf8.parse(key3);
    					let srcs = CryptoJS.enc.Utf8.parse(word1);
				        let encrypted = CryptoJS.AES.encrypt(srcs, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
				        var str = encrypted.ciphertext.toString().toUpperCase();
				        console.log(str);
				        $("#set").val(str);
    				}
    			}
			});


			//解密
			$("#decrypt_btn").click(function(){
				var word2 = $("#get").val();
				var key3 = $("#aeskey").val();
				if(typeof key3 == "undefined" || key3 == null || key3 == ""){
        			alert("没有密钥啊！");
    			}
    			else if(typeof word2 == "undefined" || word2 == null || word2 == ""){
    				alert("没有要解密的内容！");
    			}
    			else{
    				if(key3.length != 16){
    					alert("密钥位数不对吧");
    				}else{
    					console.log(key3,word2);
    					var key = CryptoJS.enc.Utf8.parse(key3);
    					let encryptedHexStr = CryptoJS.enc.Hex.parse(word2);
				        let srcs2 = CryptoJS.enc.Base64.stringify(encryptedHexStr);
				        let decrypt = CryptoJS.AES.decrypt(srcs2, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
				        let decryptedStr = decrypt.toString(CryptoJS.enc.Utf8);
				        var str2 = decryptedStr.toString();
				        $("#get").val(str2);
				        console.log(str2);
    				}
    			}
			});
			
			// 合约ABI
			var abi = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "x",
				"type": "string"
			}
		],
		"name": "set",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];
			// 合约地址
			var address = "0x88073c8813f05f6c72c19ca726595b5d68edf379";
			// 通过ABI和地址获取已部署的合约对象
			var metacoin = web3.eth.contract(abi).at(address);


			//从节点读
			$("#get_btn").click(function(){
				metacoin.get(function(error, result){
	            if(!error)
	                {
	                	$("#get").val(result);
	                    console.log(result);
	                }
	            else
	                console.error(error);
	        	});
			});

			//写入节点
			$("#set_btn").click(function(){
				var want_set = document.getElementById("set").value;
				var obj = want_set.trim();
				if(typeof obj == "undefined" || obj == null || obj == ""){
        			alert("输入些东西再试试！！！");
    			}else{
    				console.log(want_set);
					metacoin.set(want_set,function(e,r){
						console.log('status:',e,r);
					});
    			}
			});



		});
	</script>

</body>
</html>

<!-- info.set_msg($("#msg").val(), function(e,r){
                console.log('set status:', e, r)
            });

 -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="main.css">

    <script src="./web3.js"></script>

</head>
<body>
    <div class="container">

        <h1>Info Contract</h1>

        <h2 id="info"></h2>

        <label for="name" class="col-lg-2 control-label">msg</label>
        <input id="msg" type="text" placeholder="input msg">


        <button id="button">Update Info</button>


    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
       if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            alert('???')
            //web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
        }
        console.log(web3.eth.accounts);
        web3.eth.defaultAccount = web3.eth.accounts[0];

        var infoContract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [
			{
				"name": "new_m",
				"type": "string"
			}
		],
		"name": "set_msg",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "get_msg",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]);
        
        var info = infoContract.at('0xab16e8c7702dd7920baf5adbb15e73c991c4bc74');
        info.get_msg(function(error, result){
            if(!error)
                {
                    $("#info").html('msg:' + result);
                    console.log(result);
                }
            else
                console.error(error);
        });
        $("#button").click(function() {
            info.set_msg($("#msg").val(), function(e,r){
                console.log('set status:', e, r)
            });
        });
    </script>

</body>
</html>
 -->